# AGENTS.md for Debug Mode

## Проект-специфичные инструкции по отладке

### Логирование и мониторинг

#### Просмотр логов бота
```bash
# Основная команда для отладки
docker-compose logs -f bot

# Фильтрация по уровню ошибок
docker-compose logs bot | grep ERROR

# Просмотр последних 100 строк
docker-compose logs --tail=100 bot
```

#### Уровни логирования
- Установите `DEBUG=True` в .env для подробного логирования
- `LOG_LEVEL=DEBUG` для максимальной детализации
- Основные логи включают информацию о запросах к БД и обработке сообщений

### Распространенные ошибки и их диагностика

#### Ошибка: `about_project() got an unexpected keyword argument 'user'`
- **Причина**: Функция определена без параметра `user`, но декоратор `@user_required` пытается его передать
- **Решение**: Удалите декоратор `@user_required` или добавьте параметр `user` в функцию

#### Ошибки подключения к базе данных
- **Проверка**: `docker-compose ps` - убедитесь что контейнер db запущен
- **Диагностика**: `docker-compose logs db` - проверьте логи PostgreSQL
- **Тест подключения**: `docker-compose exec db psql -U postgres -d audio_bot`

#### Проблемы с аудиофайлами
- **Проверка наличия**: `docker-compose exec bot ls -la bot/audio_files/`
- **Права доступа**: `docker-compose exec bot ls -la bot/audio_files/` (проверьте права)
- **Формат**: Убедитесь что файл имеет поддерживаемый формат (mp3, wav, ogg, m4a)

### Диагностика состояний FSM

#### Проверка активных состояний
- Добавьте логирование в обработчики состояний
- Используйте `await state.get_data()` для вывода текущих данных
- Проверьте что состояние очищается: `await state.clear()`

#### Типичные проблемы с FSM
1. **Забытое состояние**: Пользователь застрял в состоянии после ошибки
2. **Неправильный переход**: Состояние установлено но обработчик не срабатывает
3. **Отсутствие очистки**: Состояние остается активным после завершения

### Отладка работы с базой данных

#### Проверка соединения с БД
```bash
# Прямое подключение к PostgreSQL
docker-compose exec db psql -U postgres -d audio_bot

# Проверка таблиц
\dt

# Проверка данных
SELECT COUNT(*) FROM users;
SELECT COUNT(*) FROM lessons;
```

#### Мониторинг запросов
- Включите `echo=True` в настройках SQLAlchemy (автоматически при DEBUG=True)
- Проверьте медленные запросы через логи
- Используйте `EXPLAIN ANALYZE` для оптимизации сложных запросов

### Ошибки декораторов безопасности

#### Проблемы с правами доступа
- **Симптом**: Пользователь получает "Доступ запрещен" при корректных правах
- **Диагностика**: Проверьте `role_id` в таблице users
- **Решение**: `UPDATE users SET role_id = 1 WHERE telegram_id = ВАШ_ID;`

#### Отладка декораторов
- Добавьте логирование внутрь декораторов для трассировки
- Проверьте что декораторы применяются в правильном порядке
- Убедитесь что типы аргументов соответствуют ожиданиям

### Тестирование функционала бота

#### Проверка команд
- `/start` - регистрация пользователя
- `/id` - получение Telegram ID
- `/admin` - административная панель (для админов)

#### Тестирование FSM процессов
1. Начните многошаговый процесс
2. Проверьте логи на каждом шаге
3. Убедитесь что состояние корректно изменяется
4. Проверьте очистку состояния после завершения

### Диагностика контейнеров Docker

#### Проверка статуса контейнеров
```bash
# Статус всех сервисов
docker-compose ps

# Детальная информация о контейнере
docker inspect audio_bot

# Ресурсы контейнера
docker stats audio_bot
```

#### Перезапуск сервисов
```bash
# Перезапуск только бота
docker-compose restart bot

# Полная перезагрузка
docker-compose down && docker-compose up -d
```

### Полезные команды отладки

#### Работа с файлами в контейнере
```bash
# Проверка содержимого директории
docker-compose exec bot ls -la bot/

# Просмотр файла
docker-compose exec bot cat bot/utils/config.py

# Копирование файла из контейнера
docker cp audio_bot:/app/bot/utils/config.py ./config_debug.py
```

#### Мониторинг ресурсов
```bash
# Использование диска
docker-compose exec bot df -h

# Память и процессор
docker-compose exec bot top
```

### Специфичные ошибки проекта

#### Ошибка валидации аудио
- **Проверка**: Используйте `AudioUtils.validate_audio_file()` перед сохранением
- **Логирование**: Добавьте информацию о формате и размере файла

#### Проблемы с путями файлов
- **Абсолютные пути**: Используйте `config.audio_files_path` для получения пути
- **Монтирование**: Убедитесь что том `bot/audio_files` смонтирован в docker-compose.yml

### Средства отладки в коде

#### Добавление отладочных сообщений
```python
import logging
logger = logging.getLogger(__name__)

# В обработчике
logger.info(f"Processing message from user {message.from_user.id}")
logger.debug(f"State data: {await state.get_data()}")
```

#### Проверка данных в БД
```python
# В сервисном методе
result = await session.execute(select(User).where(User.telegram_id == telegram_id))
user = result.scalar_one_or_none()
logger.debug(f"Found user: {user}")