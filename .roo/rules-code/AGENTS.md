# AGENTS.md for Code Mode

## Проект-специфичные правила кодирования

### Критические паттерны бота

#### Декораторы безопасности (обязательно использовать)
- `@admin_required` - для функций, требующих прав администратора
- `@moderator_required` - для функций, доступных модераторам и выше
- `@user_required` - для автоматической регистрации пользователя
- `@error_handler` - для обработки исключений с уведомлением пользователя

#### Работа с базой данных
- ВСЕ операции с БД должны использовать сервисные классы из `bot/services/database_service.py`
- Сессии только асинхронные: `async with async_session_maker() as session:`
- Не используйте прямые SQL-запросы без необходимости
- Модели используют SQLAlchemy 2.0 с async/await

#### FSM состояния aiogram
- Все многошаговые процессы должны использовать aiogram FSM
- ВСЕГДА очищайте состояние после завершения: `await state.clear()`
- Используйте декоратор `@clear_state` для автоматической очистки

### Специфичные утилиты проекта

#### AudioUtils (bot/utils/audio_utils.py)
- `validate_audio_file()` - обязательная проверка формата аудио
- `get_audio_duration()` - получение длительности через mutagen
- `save_audio_file()` - сохранение с уникальным именем (не перезаписывайте файлы)
- `format_duration()` - форматирование секунд в ЧЧ:ММ:СС

#### Конфигурация (bot/utils/config.py)
- Все настройки через Pydantic Settings из .env файла
- `config.database_url` - автоформируемый URL для БД (не формируйте вручную)
- `config.allowed_audio_formats_list` - список разрешенных форматов

### Обязательная структура моделей

#### User модель
- `telegram_id` - уникальный идентификатор (обязательное поле)
- `role_id` - ссылка на роль (по умолчанию 3 - пользователь)

#### Lesson модель
- Обязательные поля: `title`, `book_id`, `teacher_id`, `audio_path`
- Используйте `has_audio()` метод для проверки наличия аудио

#### Отношения в моделях
- Используйте `back_populates` для двусторонних связей
- `TYPE_CHECKING` для избежания циклических импортов

### Распространенные ошибки и их предотвращение

1. **Ошибка в about_project()** - функция не принимает параметр `user`
2. **Забыть await** - все операции с БД асинхронные
3. **Неправильная работа с файлами** - используйте AudioUtils для аудио
4. **Отсутствие очистки FSM** - всегда вызывайте `state.clear()`
5. **Неправильное использование декораторов** - проверьте порядок декораторов

### Особенности обработки аудиофайлов

- Поддерживаемые форматы: MP3, WAV, OGG, M4A
- Максимальный размер: 50 МБ (настраивается в .env)
- Все аудиофайлы хранятся в `bot/audio_files/`
- Используйте уникальные имена файлов через AudioUtils

### Структура обработчиков

- Пользовательские обработчики в `bot/handlers/user.py`
- Административные обработчики в `bot/handlers/admin.py`
- Используйте роутеры для организации обработчиков
- Все колбэки должны иметь обработку ответа: `await callback.answer()`

### Роли и права доступа

- **admin** (level=2): полный доступ ко всем функциям через `/admin`
- **moderator** (level=1): управление уроками и преподавателями
- **user** (level=0): просмотр и прослушивание контента

### Критические требования к коду

- Все функции обработки сообщений должны быть асинхронными
- Используйте типизацию для параметров и возвращаемых значений
- Обрабатывайте все возможные исключения
- Предоставляйте обратную связь пользователю при ошибках