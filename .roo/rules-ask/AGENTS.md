# AGENTS.md for Ask Mode

## Контекст проекта для ответов на вопросы

### Архитектура и структура

#### Основные компоненты
- **Telegram бот** на aiogram 3.x для прослушивания аудио уроков по исламским наукам
- **PostgreSQL** база данных с иерархической структурой: Темы → Книги → Уроки
- **Docker** контейнеризация с тремя сервисами: bot, db, adminer
- **Ролевая система**: admin, moderator, user с разными уровнями доступа

#### Иерархия данных
```
Темы (Акыда, Сира, Фикх, Адаб)
├── Книги (например, "4 правила")
│   ├── Автор книги (классический ученый)
│   └── Уроки
│       ├── Преподаватель (современный)
│       ├── Аудиофайл
│       └── Теги для поиска
```

### Функциональные возможности

#### Для пользователей
- Просмотр тем и книг
- Прослушивание аудио уроков
- Поиск по ключевым словам и тегам
- Скачивание аудиофайлов

#### Для администраторов
- Полное управление контентом через `/admin`
- Управление пользователями и ролями
- Просмотр статистики

#### Для модераторов
- Добавление и редактирование уроков
- Управление преподавателями

### Технические особенности

#### Работа с аудиофайлами
- Поддерживаемые форматы: MP3, WAV, OGG, M4A
- Максимальный размер: 50 МБ
- Хранение в `bot/audio_files/`
- Уникальные имена файлов через AudioUtils

#### Безопасность
- Декораторы проверки прав: `@admin_required`, `@moderator_required`
- Автоматическая регистрация через `@user_required`
- Обработка ошибок через `@error_handler`

#### Состояния (FSM)
- Многошаговые процессы используют aiogram FSM
- Обязательная очистка состояний после завершения
- Поиск уроков, добавление контента используют состояния

### Распространенные вопросы и сценарии

#### Как запустить проект?
```bash
# Клонирование и настройка
git clone <repository>
cp .env.example .env
# Редактирование .env с токеном бота и Telegram ID

# Запуск
docker-compose up -d --build

# Инициализация данных
docker-compose exec bot python init_data.py

# Назначение прав администратора
docker-compose exec db psql -U postgres -d audio_bot -c "UPDATE users SET role_id = 1 WHERE telegram_id = ВАШ_ID;"
```

#### Как добавить новый урок?
1. Через административную панель `/admin`
2. Выбрать "Управление уроками" → "Добавить урок"
3. Заполнить данные: название, книга, преподаватель
4. Загрузить аудиофайл
5. Указать теги для поиска

#### Как назначить права модератора?
```bash
# Через базу данных
docker-compose exec db psql -U postgres -d audio_bot -c "UPDATE users SET role_id = 2 WHERE telegram_id = ID_ПОЛЬЗОВАТЕЛЯ;"
```

#### Почему бот не отвечает?
1. Проверьте логи: `docker-compose logs -f bot`
2. Убедитесь что токен бота правильный
3. Проверьте статус контейнеров: `docker-compose ps`

### Особенности архитектуры

#### Разделение авторов и преподавателей
- **Авторы книг** - классические исламские ученые (например, Мухаммад ибн Абдуль-Ваххаб)
- **Преподаватели уроков** - современные преподаватели (например, Мухаммад Абу Мунира)

#### Модульная структура
- `handlers/` - обработчики команд (user.py, admin.py)
- `models/` - модели SQLAlchemy (user.py, lesson.py, book.py и т.д.)
- `services/` - бизнес-логика работы с БД
- `utils/` - утилиты (config.py, audio_utils.py, decorators.py)
- `keyboards/` - клавиатуры для интерфейса

#### Работа с базой данных
- Асинхронные сессии SQLAlchemy 2.0
- Сервисные классы для операций с БД
- Индексы для оптимизации поиска
- Полнотекстовый поиск по урокам

### Типичные проблемы и решения

#### Ошибка "Доступ запрещен"
- Проверьте роль пользователя в БД
- Убедитесь что telegram_id правильный
- Используйте `/id` для получения своего ID

#### Проблемы с аудиофайлами
- Проверьте формат файла (должен быть MP3, WAV, OGG или M4A)
- Убедитесь что размер не превышает 50 МБ
- Проверьте права доступа к директории `bot/audio_files/`

#### FSM состояния не работают
- Убедитесь что состояние установлено: `await state.set_state()`
- Проверьте что обработчик состояния существует
- Добавьте очистку состояния: `await state.clear()`

### Мониторинг и обслуживание

#### Просмотр логов
```bash
# Логи бота
docker-compose logs -f bot

# Логи базы данных
docker-compose logs -f db
```

#### Резервное копирование
```bash
# Создание бэкапа
docker-compose exec db pg_dump -U postgres audio_bot > backup.sql

# Восстановление
docker-compose exec -T db psql -U postgres audio_bot < backup.sql
```

#### Статистика
- Количество тем, книг, уроков
- Активные пользователи по ролям
- Общая длительность аудио контента

### Дополнительная информация

#### Администрирование через Adminer
- Доступно по адресу: http://localhost:8080
- Подключение: postgres/audio_bot
- Учетные данные из .env файла

#### Конфигурация
- Все настройки в .env файле
- Pydantic Settings для валидации
- Автоформируемый URL для базы данных
- Настраиваемые форматы аудио

#### Масштабирование
- Возможность миграции на кластер PostgreSQL
- Поддержка CDN для аудиофайлов
- Горизонтальное масштабирование бота