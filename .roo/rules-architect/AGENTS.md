# AGENTS.md for Architect Mode

## Архитектурные решения и ограничения проекта

### Системная архитектура

#### Компоненты и их взаимодействие
```
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│   Telegram Bot  │    │   PostgreSQL DB  │    │  File Storage   │
│   (aiogram 3.x) │◄──►│   (SQLAlchemy)   │◄──►│  (Audio Files)  │
└─────────────────┘    └──────────────────┘    └─────────────────┘
         │                       │                       │
         ▼                       ▼                       ▼
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│   FSM States    │    │   Service Layer  │    │   Audio Utils   │
│   (aiogram)     │    │  (Database Svc)  │    │   (mutagen)     │
└─────────────────┘    └──────────────────┘    └─────────────────┘
```

#### Иерархическая модель данных
```
Themes (Акыда, Сира, Фикх, Адаб)
├── Books (Книги по темам)
│   ├── BookAuthor (классические ученые)
│   └── Lessons (аудио уроки)
│       ├── LessonTeacher (современные преподаватели)
│       ├── AudioFile (физический файл)
│       └── Tags (для поиска и фильтрации)
```

### Ключевые архитектурные паттерны

#### Разделение ответственности
- **Handlers**: Обработка Telegram событий и команд
- **Services**: Бизнес-логика и операции с БД
- **Models**: SQLAlchemy модели данных
- **Utils**: Вспомогательные функции (аудио, конфигурация)
- **Keyboards**: Генерация клавиатур для интерфейса

#### Управление состоянием
- **FSM (Finite State Machine)** для многошаговых процессов
- Автоматическая очистка состояний после завершения
- Декоратор `@clear_state` для управления жизненным циклом

#### Безопасность и права доступа
- **Ролевая модель**: admin (level=2), moderator (level=1), user (level=0)
- Декораторы проверки прав для разных уровней доступа
- Автоматическая регистрация пользователей при первом взаимодействии

### Неочевидные архитектурные решения

#### Разделение авторов и преподавателей
- **BookAuthor**: Классические исламские ученые (исторические фигуры)
- **LessonTeacher**: Современные преподаватели (читают уроки)
- Это позволяет учитывать исторический контекст и современное преподавание

#### Асинхронная архитектура
- Все операции с БД асинхронные (SQLAlchemy 2.0)
- Асинхронная обработка файлов (aiofiles)
- Блокирующие операции изолированы от основного потока

#### Управление аудиофайлами
- Уникальные имена файлов для предотвращения конфликтов
- Валидация формата и размера перед сохранением
- Отделение метаданных урока от физического файла

### Ограничения и компромиссы

#### Масштабирование
- **Текущее**: Монолитный бот с локальным хранением файлов
- **Ограничение**: Один экземпляр бота обрабатывает всех пользователей
- **Потенциал**: Горизонтальное масштабирование через балансировщик нагрузки

#### Хранение аудиофайлов
- **Текущее**: Локальные файлы в смонтированном томе Docker
- **Ограничение**: Ограниченное дисковое пространство на одном сервере
- **Потенциал**: Миграция на облачное хранилище (S3, Google Cloud)

#### База данных
- **Текущее**: Один экземпляр PostgreSQL
- **Ограничение**: Единственная точка отказа
- **Потенциал**: Репликация и шардирование для высокой доступности

### Скрытые зависимости и связи

#### Циклические импорты в моделях
- Использование `TYPE_CHECKING` для разрешения циклических зависимостей
- Отложенная загрузка связей через SQLAlchemy relationships

#### FSM и обработчики сообщений
- Состояния зависят от порядка обработки сообщений
- Неявная связь между состоянием и доступными командами

#### Декораторы и контекст выполнения
- Декораторы изменяют сигнатуру функций (добавляют параметры)
- Порядок применения декораторов критически важен

### Производительность и оптимизация

#### Индексы в базе данных
- Композитные индексы для частых запросов (book_id + lesson_number)
- Полнотекстовый поиск по урокам с поддержкой русского языка
- Индексы по внешним ключам для ускорения JOIN операций

#### Кэширование
- Отсутствует явное кэширование (потенциальная точка оптимизации)
- SQLAlchemy кэширует запросы на уровне сессии
- Возможность добавления Redis для сессий и кэша

#### Асинхронные операции
- Параллельная обработка нескольких пользователей
- Асинхронные операции с БД не блокируют бота
- Потенциальное узкое место: обработка больших аудиофайлов

### Безопасность

#### Уровни защиты
- Валидация входных данных в моделях Pydantic
- Проверка прав доступа на уровне операций
- Ограничение размера загружаемых файлов

#### Потенциальные уязвимости
- Отсутствие валидации содержимого аудиофайлов
- Прямое выполнение SQL запросов (в сервисах)
- Хранение токена бота в переменных окружения

### Технический долг и рефакторинг

#### Требуется рефакторинг
- Дублирование кода в административных обработчиках
- Отсутствие абстракции для операций с БД
- Смешивание бизнес-логики и логики интерфейса

#### Потенциальные улучшения
- Внедрение репозиторного паттерна для работы с БД
- Создание абстрактных фабрик для клавиатур
- Разделение команд и запросов (CQRS)

### Мониторинг и наблюдаемость

#### Текущее состояние
- Базовое логирование через Python logging
- Отсутствие метрик производительности
- Логи доступны только через Docker

#### Рекомендации по улучшению
- Структурированное логирование в JSON формате
- Метрики производительности (Prometheus)
- Трассировка запросов для отладки

### Развертывание и DevOps

#### Текущий процесс
- Docker Compose для локальной разработки
- Ручное управление миграциями
- Отсутствие CI/CD пайплайна

#### Рекомендации
- Автоматизация развертывания
- Health checks для контейнеров
- Blue-green deployment для нулевого простоя

### Архитектурные решения для будущего

#### Микросервисная архитектура
- Выделение сервиса обработки аудио
- Отдельный сервис управления пользователями
- API Gateway для маршрутизации запросов

#### Событийная архитектура
- Брокер сообщений для асинхронной обработки
- События для уведомления об изменениях
- Отделение бизнес-событий от транспортного уровня

#### Облачная архитектура
- Контейнеризация в Kubernetes
- Облачное хранилище для аудиофайлов
- Управляемая база данных